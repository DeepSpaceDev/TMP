<script src="../../../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../elements.html">

<dom-module id="tmp-game">
	<template>
		<style>
			:host {
				display: block;
				height: 100%;
				background: #FAFAFA;
			}
			div {
			}
		</style>
		<div id="mapContainer" style="visibility: collapse">
			<tmp-map color="[[color]]" ttransform="{{ttransform}}" game="{{game}}" on-map-ready="_mapReadyCallback"></tmp-map>
		</div>
		<div id="menuContainer" style="visibility: visible">
			<tmp-menu on-start-global-game="startGlobalGame" on-join-game="joinGame"></tmp-menu>
		</div>
		<tmp-game-data data="{{gamesData}}"></tmp-game-data>
		<tmp-game-auth user-data="{{user}}"></tmp-game-auth>
	</template>
	<script>
		var blocks = []; //Map blocks, global access

		Polymer({
			is: 'tmp-game',

			properties: {
				gameRunning: {
					type: Boolean,
					notify: true,
					value: false,
					observer: '_gameStatusChanged'
				},
				gamesData: {
					type: Array,
					notify: true
				},
				game: {
					type: Object,
					notify: true
				},
				gameId: {
					type: String
				},
				ttransform: {
					type: Number,
					value: 1,
					notify: true
				},
				color: {
					type: String,
					notify: true,
					value: 'rgb(255,152,0)'
				},
				user: {
					type: Object
				}
			},

			selectGame: function() {
				for (var i = 0; i < this.gamesData.length; i++) {
					if(this.gamesData[i].gameId === this.gameId) {
						this.set('game', this.gamesData[i]);
						this.linkPaths('game', 'gamesData.' + i);
					}
				}
			},
			
			startGlobalGame: function(e) {
				this.set('gameRunning', true);

				var gameId = getRandomString(6);
				this.set('gameId', gameId);
				if(e.detail.color !== 'rgb(undefined, undefined, undefined)')
					this.set('color', e.detail.color);

				var player = {id: this.user.uid};
				var players = [player];

				this.push('gamesData', {
					gameId: gameId,
					maxPlayers: e.detail.maxPlayers,
					players: players
				});

				this.selectGame();

				$("map").html("");
				qs('tmp-map').generateMap(e.detail.width);
				qs('tmp-map').mapTo_16_9();
				qs('tmp-map').runLabAlgor();
				qs('tmp-map').drawMap();
			},

			joinGame: function(e) {
				var gameId = e.detail.gameId;
				for (var i = 0; i < this.gamesData.length; i++) {
					if(this.gamesData[i].gameId === gameId) {
						// var map = this.gamesData[i].map;
						var map = this.get('map', this.gamesData[i]);
						qs('tmp-map').generateMap(JSON.parse(map).length);
						qs('tmp-map').drawMap(map);
						this.set('gameRunning', true);
					}
				}
				this.selectGame();
			},

			_gameStatusChanged: function(){
				if(this.gameRunning) {
					this.$.mapContainer.style.visibility = 'visible';
					this.$.menuContainer.style.visibility = 'collapse';
				} else {
					this.$.menuContainer.style.visibility = 'visible';
					this.$.mapContainer.style.visibility = 'collapse';
				}
			},

			_mapReadyCallback: function(e) {
				this.set('ttransform', (($("#border0_0").height() * 0.6) / 106.05));
				for (var i = 0; i < this.gamesData.length; i++) {
					if(this.gamesData[i].gameId === this.gameId) {
						var map = JSON.stringify(blocks);
						var game = this.get('gamesData.' + i);
						game.map = map; // WHY IS THIS SHIT WORKING :OOO !!!!
					}
				}
			}
		});
	</script>
</dom-module>