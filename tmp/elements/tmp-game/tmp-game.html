<dom-module id="tmp-game">
	<template>
		<style>
			:host {
				display: block;
				height: 100%;
				background: #FAFAFA;
			}
			div {
			}
		</style>
		<div id="mapContainer" style="visibility: collapse">
			<tmp-map on-map-ready="_uploadJSON"></tmp-map>
		</div>
		<div id="menuContainer" style="visibility: visible">
			<tmp-menu on-start-global-game="startGlobalGame" on-join-game="joinGame"></tmp-menu>
		</div>
		<tmp-game-data data="{{gameData}}"></tmp-game-data>
	</template>
	<script>
		Polymer({
			is: 'tmp-game',

			properties: {
				gameRunning: {
					type: Boolean,
					notify: true,
					value: false,
					observer: '_gameStatusChanged'
				},
				gameData: {
					notify: true
				},
				gameId: {
					type: String
				}
			},

			listeners: {
				'map-ready': '_uploadJSON'
			},

			startGlobalGame: function(e) {
				this.set('gameRunning', true);

				var gameId = generateGameId(6);
				this.set('gameId', gameId);

				this.push('gameData', {
					gameId: gameId,
					maxPlayers: e.detail.maxPlayers
				});

				$("map").html("");
				generateMap(e.detail.width);
				mapTo_16_9();
				runLabAlgor();
				drawMap();
			},

			joinGame: function(e) {
				var gameId = e.detail.gameId;
				for (var i = 0; i < this.gameData.length; i++) {
					if(this.gameData[i].gameId === gameId) {
						var map = this.gameData[i].map;
						generateMap(JSON.parse(map)[0].length);
						drawMap(map);
						this.set('gameRunning', true);
					}
				}
			},

			_gameStatusChanged: function(){
				if(this.gameRunning) {
					this.$.mapContainer.style.visibility = 'visible';
					this.$.menuContainer.style.visibility = 'collapse';
				} else {
					this.$.menuContainer.style.visibility = 'visible';
					this.$.mapContainer.style.visibility = 'collapse';
				}
			},

			_uploadJSON: function(e) {
				for (var i = 0; i < this.gameData.length; i++) {
					if(this.gameData[i].gameId === this.gameId) {
						var map = JSON.stringify(blocks);
						this.set('gameData.' + i + '.map', map);
					}
				}
			}
		});
	</script>
</dom-module>