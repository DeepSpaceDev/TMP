<dom-module id="tmp-tank">
	<template>
	<style>
		:host {
			display: block;
			position: absolute;
			transform-origin: 35.8px 60%;
			height: 106.05px;
			width: 71.6px;
		}
		.tank{
			position: absolute;
		}
	</style>
	<section>
		<svg class="tank" xmlns:xlink="http://www.w3.org/1999/xlink" height="106.05px" width="71.6px" xmlns="http://www.w3.org/2000/svg">
			<g transform="matrix(1, 0, 0, 1, 35.8, 65.55)">
			<use height="81.0" class="base" transform="matrix(1.0, 0.0, 0.0, 1.0, -30.5, -40.5)" width="61.0" xlink:href="#sprite0"/>
			<use height="98.05" class="turret" transform="matrix(1.0, 0.0, 0.0, 1.0, -35.8, -65.55)" width="71.6" xlink:href="#sprite2"/>
			</g>
			<defs>
			<g id="sprite0" transform="matrix(1, 0, 0, 1, 30.5, 40.5)">
			  <use height="80.0" id="background" transform="matrix(1.0, 0.0, 0.0, 1.0, -30.0, -40.0)" width="60.0" xlink:href="#sprite1"/>
			  <use height="81.0" transform="matrix(1.0, 0.0, 0.0, 1.0, -30.5, -40.5)" width="61.0" xlink:href="#shape1"/>
			</g>
			<g id="sprite1" transform="matrix(1, 0, 0, 1, 30.0, 40.0)">
			  <use height="80.0" transform="matrix(1.0, 0.0, 0.0, 1.0, -30.0, -40.0)" width="60.0" xlink:href="#shape0"/>
			</g>
			<g id="shape0" transform="matrix(1, 0, 0, 1, 30.0, 40.0)">
			  <path class="colorw" d="M30.0 -40.0 L30.0 40.0 -30.0 40.0 -30.0 -40.0 30.0 -40.0" fill="#ffffff" fill-rule="evenodd" stroke="none"/>
			</g>
			<g id="shape1" transform="matrix(1, 0, 0, 1, 30.5, 40.5)">
			  <path d="M17.5 -40.0 L30.0 -40.0 30.0 40.0 17.5 40.0 17.5 -40.0 M-17.5 40.0 L-30.0 40.0 -30.0 -40.0 -19.55 -39.95 -17.15 -39.9 -17.45 37.5 -17.5 37.5 -17.5 40.0" fill="url(#gradient0)" fill-rule="evenodd" stroke="none"/>
			  <path d="M17.5 -40.0 L17.5 40.0 -17.5 40.0 -17.5 37.5 -17.45 37.5 -17.15 -39.9 -19.55 -39.95 17.5 -40.0" fill="url(#gradient1)" fill-rule="evenodd" stroke="none"/>
			  <path d="M30.0 40.0 L-30.0 40.0 -30.0 -40.0 30.0 -40.0 30.0 40.0" fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.0"/>
			</g>
			<linearGradient gradientTransform="matrix(0.0, -0.0488, 0.0488, 0.0, -23.6, 0.0)" gradientUnits="userSpaceOnUse" id="gradient0" spreadMethod="pad" x1="-819.2" x2="819.2">
			  <stop offset="0.0" stop-color="#000000" stop-opacity="0.6"/>
			  <stop offset="0.11764705882352941" stop-color="#000000" stop-opacity="0.3019608"/>
			  <stop offset="0.8941176470588236" stop-color="#000000" stop-opacity="0.2"/>
			  <stop offset="1.0" stop-color="#000000" stop-opacity="0.6"/>
			</linearGradient>
			<linearGradient gradientTransform="matrix(0.0, -0.0488, 1.0, 1.0E-4, 0.0, 0.0)" gradientUnits="userSpaceOnUse" id="gradient1" spreadMethod="pad" x1="-819.2" x2="819.2">
			  <stop offset="0.0" stop-color="#000000" stop-opacity="0.6"/>
			  <stop offset="0.0392156862745098" stop-color="#000000" stop-opacity="0.4"/>
			  <stop offset="0.15294117647058825" stop-color="#000000" stop-opacity="0.0"/>
			  <stop offset="0.7137254901960784" stop-color="#000000" stop-opacity="0.0"/>
			  <stop offset="0.8352941176470589" stop-color="#000000" stop-opacity="0.1254902"/>
			  <stop offset="0.9568627450980393" stop-color="#000000" stop-opacity="0.4"/>
			  <stop offset="1.0" stop-color="#000000" stop-opacity="0.6"/>
			</linearGradient>
			<g id="sprite2" transform="matrix(1, 0, 0, 1, 35.8, 65.55)">
			  <use height="77.5" id="background" transform="matrix(1.0, 0.0, 0.0, 1.0, -22.5, -55.0)" width="45.0" xlink:href="#sprite3"/>
			  <use height="77.5" transform="matrix(1.0, 0.0, 0.0, 1.0, -22.5, -55.0)" width="45.0" xlink:href="#shape3"/>
			</g>
			<g id="sprite3" transform="matrix(1, 0, 0, 1, 22.5, 38.75)">
			  <use height="77.5" transform="matrix(1.0, 0.0, 0.0, 1.0, -22.5, -38.75)" width="45.0" xlink:href="#shape2"/>
			</g>
			<g id="shape2" transform="matrix(1, 0, 0, 1, 22.5, 38.75)">
			  <path class="colorw" d="M7.5 -5.0 Q12.15 -3.4 15.9 0.35 22.5 6.95 22.5 16.25 22.5 25.55 15.9 32.15 9.3 38.75 0.0 38.75 -9.3 38.75 -15.9 32.15 -22.5 25.55 -22.5 16.25 -22.5 6.95 -15.9 0.35 -12.15 -3.4 -7.5 -5.0 L-7.5 -38.75 7.5 -38.75 7.5 -5.0" fill="#ffffff" fill-rule="evenodd" stroke="none"/>
			</g>
			<g id="shape3" transform="matrix(1, 0, 0, 1, 22.5, 55.0)">
			  <path d="M7.5 -21.25 Q12.15 -19.65 15.9 -15.9 22.5 -9.3 22.5 0.0 22.5 9.3 15.9 15.9 9.3 22.5 0.0 22.5 -9.3 22.5 -15.9 15.9 -22.5 9.3 -22.5 0.0 -22.5 -9.3 -15.9 -15.9 -12.15 -19.65 -7.5 -21.25 L0.0 0.0 7.5 -21.25" fill="url(#gradient2)" fill-rule="evenodd" stroke="none"/>
			  <path d="M-7.5 -21.25 L-7.5 -55.0 7.5 -55.0 7.5 -21.25 0.0 0.0 -7.5 -21.25" fill="url(#gradient3)" fill-rule="evenodd" stroke="none"/>
			  <path d="M7.5 -21.25 Q12.15 -19.65 15.9 -15.9 22.5 -9.3 22.5 0.0 22.5 9.3 15.9 15.9 9.3 22.5 0.0 22.5 -9.3 22.5 -15.9 15.9 -22.5 9.3 -22.5 0.0 -22.5 -9.3 -15.9 -15.9 -12.15 -19.65 -7.5 -21.25 L-7.5 -55.0 7.5 -55.0 7.5 -21.25" fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="0.05"/>
			</g>
			<radialGradient cx="0" cy="0" gradientTransform="matrix(0.0275, 0.0, 0.0, 0.0275, 0.0, 0.0)" gradientUnits="userSpaceOnUse" id="gradient2" r="819.2" spreadMethod="pad">
			  <stop offset="0.5137254901960784" stop-color="#000000" stop-opacity="0.0"/>
			  <stop offset="1.0" stop-color="#000000" stop-opacity="0.5019608"/>
			</radialGradient>
			<linearGradient gradientTransform="matrix(0.0089, 0.0, 0.0, 0.0192, 0.0, -37.15)" gradientUnits="userSpaceOnUse" id="gradient3" spreadMethod="pad" x1="-819.2" x2="819.2">
			  <stop offset="0.0" stop-color="#000000" stop-opacity="0.5019608"/>
			  <stop offset="0.27058823529411763" stop-color="#000000" stop-opacity="0.0"/>
			  <stop offset="0.7254901960784313" stop-color="#000000" stop-opacity="0.0"/>
			  <stop offset="1.0" stop-color="#000000" stop-opacity="0.5019608"/>
			</linearGradient>
			</defs>
		</svg>
	</section>
	</template>
	<script>
		Polymer({
			is: 'tmp-tank',

			properties: {
				client: {
					type: Boolean,
					value: false
				},
				ttransform: {
					type: Number,
					observer: 'customiseTank'
				},
				tcolor: {
					type: String,
					value: "#bbbbff",
					observer: 'setColor'
				},
				player: {
					type: Object,
					notify: true,
					value: function() {
						return {
							top: 100,
							left: 100,
							rotation: 0
						}
					}
				}
			},

			observers: ['updateTransformation(player.*)'],

			attached: function(){
				if(this.client){
					this.regKeyListener();
				}
				this.setColor();
			},
			setColor: function(){
				$(".colorw").attr("fill", this.tcolor);
			},
			move: function(type, id) {
				var ctop = ((this.style.top == "") ? 0 : parseFloat(this.style.top.replace("px", "")));
				var cleft =  ((this.style.left == "") ? 0 : parseFloat(this.style.left.replace("px", "")));
				// var ctop = this.top;
				// var cleft = this.left;
				var tmove = 0;
				var lmove = 0;
				var rotation = ((this.rotation === undefined) ? 0 : this.rotation * (Math.PI/180));
				var movespeed = (100 / blocks.length) / 5.3; //best value

				if(type == "forward"){
					lmove = Math.sin(rotation) * movespeed				
					tmove = Math.cos(rotation) * -1 * movespeed;
				}
				else if(type == "backward"){
					lmove = Math.sin(rotation) * -1 * movespeed				
					tmove = Math.cos(rotation) * movespeed;
				}
				if(!this.intersectBorder(id)){
					// this.set('top', ctop + tmove);
					// this.set('left', cleft + lmove);
					this.style.top = (ctop + tmove) + "px";
					this.style.left = (cleft + lmove) + "px";
				}
			},			
			rotate: function(type, id) {
				var rotspeed = 2.2;
				var nrotate = ((this.player.rotation === undefined) ? 0 : this.player.rotation);
				if(type == "right") {
					nrotate = nrotate + rotspeed;
				}
				else if(type == "left") {
					nrotate = nrotate - rotspeed;
				}
				if(!this.intersectBorder(id)) {
					this.set('player.rotation', nrotate);
				}
			},

			updateTransformation: function(changeRecord) {
				// this.style.top = top + 'px';
				// this.style.left = left + 'px';
				console.log(changeRecord);
				if(changeRecord.path === 'player.top') {

				} else if(changeRecord.path === 'player.left') {

				} else if(changeRecord.path === 'player.rotation') {
					this.style.transform = "rotate(" + changeRecord.value + "deg) scale(" + this.ttransform + ")";
				}
			},

			regKeyListener: function() {
				var forward, backward, right, left;
				var rot;
				var id = this.id;

				var interlenght = 10;
				var that = this;

				window.onkeydown = function(e) {
	   				var key = e.keyCode ? e.keyCode : e.which;
	   				if((key == 83 || key == 40) && !backward) {
	   					e.preventDefault();
	   					backward = setInterval(function() {
	   						that.move("backward", id);
	   					}, interlenght);
	   				}
	   				if((key == 87 || key == 38) && !forward) {
	   					e.preventDefault();
	   					forward = setInterval(function() {
	   						that.move("forward", id);
	   					}, interlenght);
	   				}
					if((key == 68 || key == 39) && !right) {
						e.preventDefault();
						right = setInterval(function() {
						 	that.rotate("right", id);
						 }, interlenght);
					}
	   				if((key == 65 || key == 37) && !left) {
	   					e.preventDefault();
	   					left = setInterval(function() {
	   					 	that.rotate("left", id);
	   					 }, interlenght);
	   				}				
	   			}
	   			window.onkeyup = function(e) {
	   				var key = e.keyCode ? e.keyCode : e.which;
	   				if(key == 83 || key == 40) {
	   					e.preventDefault();
	   					clearInterval(backward);
	   					backward = null;
	   				}
	   				if(key == 87 || key == 38) {
	   					e.preventDefault();
	   					clearInterval(forward);
	   					forward = null;
	   				}
	   				if(key == 68 || key == 39) {
	   					e.preventDefault();
	   					clearInterval(right);
	   					right = null;
	   				}
	   				if(key == 65 || key == 37) {
	   					e.preventDefault();
	   					clearInterval(left);
	   					left = null;
	   				}
	   			}
			},
			customiseTank: function() {
				console.log('transform: ' + this.ttransform);
				console.log(this.rotation);
				var rotation = (this.rotation === undefined) ? "" : "rotate(" + this.rotation + "deg) ";
				console.log(rotation);
				this.style.transform = rotation + "scale(" + this.ttransform + ")";
				console.log(this.style.transform);
			},
			intersectBorder: function(id){
				var tank = this;
				var jtank = $("#" + id);
				var borderStr = 4;
				for(var i = 0; i < blocks.length; i++){
					for(var j = 0; j < blocks[i].length; j++){
						var belem = qs("#border" + i + "_" + j);
						var jbelem = $("#border" + i + "_" + j);
						var baserect = qs("#" + id + " .base").getBoundingClientRect();

						if(intersects(this,	belem)){
							if(jbelem.hasClass("btop")){
								if(baserect.top  < (jbelem.offset().top + (borderStr / 2)) && baserect.bottom > (jbelem.offset().top + (borderStr / 2))){
									if(baserect.top + 1 < (jbelem.offset().top + (borderStr / 2))){
										tank.style.top = (parseInt(tank.style.top.replace("px", "")) - 1) + "px";
									}
									if(baserect.bottom - 1 > (jbelem.offset().top + (borderStr / 2))){
										tank.style.top = (parseInt(tank.style.top.replace("px", "")) + 1) + "px";
									}
									return true;
								}
							}
							/*if(jbelem.hasClass("bleft")){
								if(baserect.left  < (jbelem.offset().left + (borderStr / 2)) && //borderstrenght --> tmp-map
									baserect.right > (jbelem.offset().left + (borderStr / 2))){
									l(true);
									return true;
								}
							}
							/*if(jbelem.hasClass("bright")){
								l(baserect.top + " " + (jbelem.offset().top + (borderStr / 2)));
								if(baserect.top  < (jbelem.offset().top + (borderStr / 2)) && //borderstrenght --> tmp-map
									baserect.bottom > (jbelem.offset().top + (borderStr / 2))){
									l(true);
									return true;
								}
							}
							if(jbelem.hasClass("bbottom")){
								l(baserect.top + " " + (jbelem.offset().top + (borderStr / 2)));
								if(baserect.top  < (jbelem.offset().top + (borderStr / 2)) && //borderstrenght --> tmp-map
									baserect.bottom > (jbelem.offset().top + (borderStr / 2))){
									l(true);
									return true;
								}
							}*/
						}
					}
				}
			}
		});
	</script>
</dom-module>